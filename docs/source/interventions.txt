Interventions
*************

Any client can assume the role of an intervention.  By doing so, the client
becomes the **official** implementation for said role.

Controlling access to interventions deserves special mention.  On the
`/client/<client_id>` page, one can set the value of 'public_accessible'.

.. note::

   With *public_accessible* set, the intervention will always be displayed.

When 'public_accessible' is **not** set, two additional options exist for
enabling said intervention.

    1. To control per user, the service account associated with the intervention
    should make use of the */api/intervention/<intervention_name>/* endpoint.

    2. Alternatively, any number of *straegy* functions can be added to an
    intervention, to give access to any subgroup of users as defined by the
    strategy itself.  The available strategies are defined in the
    `portal.models.intervention_strategies` module.  Use the
    */api/intervention/<intervention_name>/access_rule* endpoint to view ori
    modify.

.. note::

   All of the checks above function as a short-circuited **or**.  That is,
   the first check that evaluates as True grants the user access to the
   intervention.

For example, to add a rule that enables the *care_plan* intervention for
users registered with the `UCSF` clinic::

    $ cat data
    {"name": "UCSF Patients",
     "function_details": {
       "function": "limit_by_clinic",
       "kwargs': [{"name": "orgainzation_name",
                 "value": "UCSF"},]
      }
    }

    $ curl -H 'Authorization: Bearer <valid-token>' \
      -H 'Content-Type: application/json' -X POST -d @data \
      https://stg.us.truenth.org/api/intervention/care_plan/access_rule

Sometimes it is necessary to combine multiple strategies into a logical
**AND** operation.  To do so, use the `combine_strategies` function,
passing the respective set of `strategy_n` and `strategy_n_kwargs` as so::

    {
      "name": "not in sr AND in clinc uw",
      "function_details": {
        "function": "combine_strategies",
        "name": "not in sr AND in clinc uw",
        "kwargs": [{
          "name": "strategy_1",
          "value": "allow_if_not_in_intervention"
        }, {
          "name": "strategy_1_kwargs",
          "value": [{
            "name": "intervention_name",
            "value": "sexual_recovery"
          }]
        }, {
          "name": "strategy_2",
          "value": "limit_by_clinic"
        }, {
          "name": "strategy_2_kwargs",
          "value": [{
            "name": "organization_name",
            "value": "UW Medicine (University of Washington)"
          }]
        }]
      }
    }

The full list of strategies used for DECISION_SUPPORT_P3P::

    {
      "name": "not in SR _and_ in clinc UW _and_ not started TX _and_ has PCaLocalized",
      "function_details": {
        "function": "combine_strategies",
        "name": "not in SR _and_ in clinc UW _and_ not started TX _and_ has PCaLocalized",
        "kwargs": [{
          "name": "strategy_1",
          "value": "allow_if_not_in_intervention"
        }, {
          "name": "strategy_1_kwargs",
          "value": [{
            "name": "intervention_name",
            "value": "sexual_recovery"
          }]
        }, {
          "name": "strategy_2",
          "value": "limit_by_clinic"
        }, {
          "name": "strategy_2_kwargs",
          "value": [{
            "name": "organization_name",
            "value": "UW Medicine (University of Washington)"
          }]
        }, {
          "name": "strategy_3",
          "value": "observation_check"
        }, {
          "name": "strategy_3_kwargs",
          "value": [{
            "name": "display",
            "value": "treatment begun"
          }, {
            "name": "boolean_value",
            "value": "false"
          }]
        }, {
          "name": "strategy_4",
          "value": "observation_check"
        }, {
          "name": "strategy_4_kwargs",
          "value": [{
            "name": "display",
            "value": "PCa localized diagnosis"
          }, {
            "name": "boolean_value",
            "value": "true"
          }]
        }]
      }
    }
