{% extends "layout.html" %}
{% block main %}
<div id="patientList" class="reduce-font-sizes">

<h4 class="tnth-headline">Patient List</h4>
<br/>
<div><a  href="{{ url_for('patients.profile_create') }}"><button class="create-user-link btn btn-lg btn-tnth-primary">{{ _("Create a patient record") }}</button></a> {{ _("or select a patient below to view or update details.") }}</div>
<a href="" id="_downloadLink" target="_blank" style="visibility: hidden"></a>
<hr/>

{% if config.PROVIDER_BULK_DATA_ACCESS %}
    <div class="download-wrapper">
      <div class="orglist-download-container">
          <div>
            <a href="javascript:void(0);" id="patientAssessmentDownload" class="create-user-link btn btn-lg btn-tnth-primary" data-toggle="modal" data-target="#dataDownloadModal"><span class="glyphicon glyphicon-save"></span>&nbsp;{{ _("Export assessment data") }}</a>
          </div>
      </div>
    </div>
    <div class="modal fade" id="dataDownloadModal" tabindex="-1" role="dialog" aria-labelledby="patientDataDownloadModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="dataDownloadLabel">{{ _("Export assessment data") }}</h4>
              </div>
              <div class="modal-body" style="padding: 1em">
                  <div class="form-group">
                    <label><em class="text-muted">{{ _("Instrument(s) to export data from:")}}</em></label>
                    <div id="patientsInstrumentList" class="profile-radio-list" style="margin-left:1em">
                      {% for instrument_code in config["INSTRUMENTS"] %}
                      <div class="checkbox">
                          <label>
                              <input type="checkbox" name="instrument" value="{{ instrument_code }}">{{ instrument_code | replace("_", " ") | upper }}
                          </label>
                      </div>
                      {% endfor %}
                      <div id="_downloadMessage" style="color:#a94442"></div>
                    </div>
                  </div>
                  <br/>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" id="patientsDownloadButton" style="font-size:0.8em">{{ _("Export") }}</button>
                <button type="button" class="btn btn-default" data-dismiss="modal" style="font-size:0.8em">{{ _("Close") }}</button>
              </div>
            </div>
          </div>
    </div>
    <hr class="download-break"/>
{% endif %}

{% if org_list_by_parent|length > 1 %}
<div class="small orgLinks">
    <p>Skip to:</p>
    <ul style="list-style-type: circle">
        {% for parent_id in org_list_by_parent %}
          {% for org in org_list_by_parent[parent_id] | sort(attribute='id') %}
              {% if org.id != parent_id %}
                <ul style="list-style-type: disc"><li><a href="#location{{org.id}}">{{ org.name }}</a></li></ul>
              {% else %}
                <li><a href="#location{{org.id}}">{{ org.name }}</a></li>
              {% endif %}
          {% endfor %}
        {% endfor %}
    </ul>
</div>
{% endif %}

<hr />
{% for parent_id in org_list_by_parent %}
  {% set orgCount = 1 %}
  {% for org in org_list_by_parent[parent_id] | sort(attribute='id')%}
      <div class="admin-table table-responsive smaller-text">
          <h4 id="location{{org.id}}">{{ org.name }} {{ _("Patients") }}</h4>

          <div id="adminTableToolbar{{org.id}}" class="admin-toolbar">
          <span id="tableCount{{org.id}}"></span></div>
          <table id="adminTable{{org.id}}"
                 data-table-id="adminTable{{org.id}}"
                 class="tnth-admin-table"
                 data-classes="table table-hover table-condensed table-striped table-responsive"
                 data-toggle="table"
                 data-sort-name="userid"
                 data-sort-order="desc"
                 data-search="true"
                 data-pagination="true"
                 data-page-size="50"
                 data-page-list="[25,50,100,ALL]"
                 data-toolbar="#adminTableToolbar{{org.id}}"
                 data-show-toggle="true"
                 data-show-columns="true"
                 data-smart-display="true"
                 >
              <thead>
                  <tr>
                      <th data-field="userid" data-sortable="true" data-sorter="tnthTables.stripLinksSorter">{{ _("ID") }}</th>
                      <th data-field="username" data-sortable="true" data-visible="false">{{ _("Username") }}</th>
                      <th data-field="firstname" data-sortable="true">{{ _("First Name") }}</th>
                      <th data-field="lastname" data-sortable="true">{{ _("Last Name") }}</th>
                      <th data-field="email" data-sortable="true">{{ _("Email") }}</th>
              {% if 'reports' in config.PATIENTS_BY_PROVIDER_ADDL_FIELDS %}
                      <th data-field="provider_html" data-sortable="true">{{ _("Reports") }}</th>
              {% endif %}
                      <th data-field="consent_date" data-sortable="true" class="text-center">{{ _("Consent Date (GMT)")}}</th>
              {% if 'status' in config.PATIENTS_BY_PROVIDER_ADDL_FIELDS %}
                      <th data-field="status" data-sortable="true" class="text-center">{{ _("Assessment Status") }}</th>
              {% endif %}
                  </tr>
              </thead>
              <tbody data-link="row" class="rowlink">
              {% for user in org.users %}
                  <tr>
                      <td><a href="{{ url_for('patients.patient_profile', patient_id=user.id) }}">{{ user.id }}</a></td>
                      <td>{{ user.username }}</td>
                      <td>{{ user.first_name if user.first_name }}</td>
                      <td>{{ user.last_name if user.last_name }}</td>
                      <td>{{ user.email if user.email }}</td>
                    {% if 'reports' in config.PATIENTS_BY_PROVIDER_ADDL_FIELDS %}
                      <td class="rowlink-skip">{{ user.provider_html() | safe }}</td>
                    {% endif %}
                       <td class="text-center">{{ user.consent_date if user.consent_date}}</td>
                    {% if 'status' in config.PATIENTS_BY_PROVIDER_ADDL_FIELDS %}
                      <td class="text-center">
                        {{ user.assessment_status }}
                      </td>
                    {% endif %}
                  </tr>
              {% endfor %}
              </tbody>
          </table>
      </div>
    {% if orgCount < org_list_by_parent[parent_id]|length %}
        <hr />
    {% endif %}
    {% set orgCount = orgCount + 1 %}
  {% endfor %}
{% endfor %}

</div>

{% endblock %}
{% block document_ready %}

$(".tnth-admin-table").bootstrapTable({
    formatShowingRows: function (pageFrom, pageTo, totalRows) {
        var thisId = $(this).attr("tableId");
        var rowInfo = "Showing "+pageFrom+" to "+pageTo+" of "+totalRows+" users";
        $("#tableCount"+thisId).html(rowInfo);
        return rowInfo;
    }
});
$(document).ready(function() {
  $(document).delegate("#patientsDownloadButton", "click", function(event){
    var instruments = "";
    $("input[name='instrument'").each(function() {
        if ($(this).is(":checked")) {
          instruments += (instruments != "" ? "&": "") + "instrument_id="+$(this).val();
        };
    });
    if (instruments != "") {
        //alert(instruments)
        $("#_downloadMessage").text("");
        $("#_downloadLink").attr("href", "/api/patient/assessment?" + instruments);
        $("#_downloadLink")[0].click();
        //$("#dataDownloadModal").modal("hide");
    } else {
        $("#_downloadMessage").text("Please choose at least one instrument.");
    };
  });

  $("input[name='instrument']").on("click", function() {
      if ($(this).is(":checked")) $("#_downloadMessage").text("");
  });
});

{% endblock %}

