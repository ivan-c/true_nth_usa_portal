{% extends "layout.html" %}
{% block main %}
  <div id="patientList" class="reduce-font-sizes">
    <h4 class="tnth-headline">Patient List</h4>
    <br/>
    <div><button id="createUserLink" onclick="location.replace('/patients/profile_create')" class="create-user-link btn btn-lg btn-tnth-primary">{{ _("Create a patient record") }}</button>&nbsp;<em>{{_("or ")}}</em>&nbsp;<span class="profile-item-title">{{ _("Select a patient below to view or update details.") }}</span></div>
    <a href="" id="_downloadLink" target="_blank"></a>
    <hr/>
  {% if config.PROVIDER_BULK_DATA_ACCESS %}
      <div class="modal fade" id="dataDownloadModal" tabindex="-1" role="dialog" aria-labelledby="patientDataDownloadModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="dataDownloadLabel">{{ _("Export assessment data") }}</h4>
              </div>
              <div class="modal-body">
                  <div class="form-group">
                    <label><em class="text-muted">{{ _("Instrument(s) to export data from:")}}</em></label>
                    <div id="patientsInstrumentList" class="profile-radio-list">
                      {% for instrument_code in config["INSTRUMENTS"] %}
                      <div class="checkbox"><label><input type="checkbox" name="instrument" value="{{ instrument_code }}">{{ instrument_code | replace("_", " ") | upper }}</label>
                      </div>
                      {% endfor %}
                      <div id="_downloadMessage"></div>
                    </div>
                  </div>
                  <br/>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" id="patientsDownloadButton">{{ _("Export") }}</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">{{ _("Close") }}</button>
              </div>
            </div>
          </div>
      </div>
  {% endif %}
  <div class="admin-table table-responsive smaller-text">
      <div id="adminTableToolbar" class="admin-toolbar">
        {% if config.PROVIDER_BULK_DATA_ACCESS %}
          <div class="orglist-download-container"><div><a href="#" id="patientAssessmentDownload" class="create-user-link btn btn-lg btn-tnth-primary" data-toggle="modal" data-target="#dataDownloadModal">{{ _("Export assessment data") }} &nbsp;<span class="glyphicon glyphicon-save"></span></a></div>
         </div>
         <div id="orglistSelector" class="dropdown btn-group orglist-selector">
            <button id="orglist-dropdown" class="create-user-link btn btn-secondary btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Filter List By Clinic &nbsp;<span class="glyphicon glyphicon-menu-down text-muted"></span><span class="glyphicon glyphicon-menu-up text-muted tnth-hide"></span>
            </button>
            <div id="org-menu" class="dropdown-menu" aria-labelledby="orglist-dropdown">
              <div class="form-group smaller-text" id="userOrgs">
                <div id="fillOrgs" class="smaller-text"></div>
              </div>
            </div>
          </div>
        {% endif %}
        <span id="tableCount"></span>
      </div>
      <table id="adminTable"
             data-table-id="adminTable"
             class="tnth-admin-table"
             data-classes="table table-hover table-condensed table-striped table-responsive"
             data-toggle="table"
             data-sort-name="userid"
             data-sort-order="desc"
             data-search="true"
             data-pagination="true"
             data-page-size="15"
             data-page-list="[15, 25, 50]"
             data-toolbar="#adminTableToolbar"
             data-show-toggle="true"
             data-show-columns="true"
             data-smart-display="true"
             data-unique-id="id"
             data-id-field="id"
             >
          <thead>
              <tr>
                  <th data-field="id" data-visible="false" data-card-visible="false" data-sortable="false" data-class="tnth-hide">
                  <th data-field="userid"  data-sortable="true" data-sorter="tnthTables.stripLinksSorter" data-class="id-field">{{ _("ID") }}</th>
                  <th data-field="username" data-sortable="true" data-visible="false">{{ _("Username") }}</th>
                  <th data-field="firstname" data-sortable="true">{{ _("First Name") }}</th>
                  <th data-field="lastname" data-sortable="true">{{ _("Last Name") }}</th>
                  <th data-field="email" data-sortable="true" data-class="email-field">{{ _("Email") }}</th>
                   <th data-field="phone" data-sortable="true" data-visible="false" data-width="10%" data-class="phone-field">{{ _("Cell") }}</th>
                  {% if 'reports' in config.PATIENTS_BY_PROVIDER_ADDL_FIELDS %}<th data-field="provider_html" data-sortable="true" data-class="reports-field">{{ _("Reports") }}</th>{% endif %}
                  {% if 'status' in config.PATIENTS_BY_PROVIDER_ADDL_FIELDS %}<th data-field="status" data-sortable="false" data-card-visible="false" data-searchable="false" data-class="status-field">{{ _("Assessment Status") }}</th>{% endif %}
                  <th data-field="consentdate" data-sortable="false" data-card-visible="false" data-searchable="false" data-class="consentdate-field text-center">{{_("Consent Date (GMT)")}}</th>
                  <th data-field="organization" data-sortable="true" data-class="organization-field">{{ _("Organization(s)") }}</th>
              </tr>
          </thead>
          <tbody id="admin-table-body" data-link="row" class="rowlink">
               {% for patient in patients_list | sort(attribute='id')%}
                  <tr id="id_row_{{patient.id}}">
                      <td>{{patient.id}}</td>
                      <td><a href="{{ url_for('patients.patient_profile', patient_id=patient.id) }}">{{ patient.id }}</a></td>
                      <td id="{{patient.id}}_username">{{ patient.username }}</td>
                      <td>{{ patient.first_name if patient.first_name }}</td>
                      <td>{{ patient.last_name if patient.last_name }}</td>
                      <td>{{ patient.email if patient.email }}</td>
                      <td>{{ patient.phone if patient.phone}}</td>
                      {% if 'reports' in config.PATIENTS_BY_PROVIDER_ADDL_FIELDS %}
                        <td class="rowlink-skip">{{ patient.provider_html() | safe }}</td>
                      {% endif %}
                      {% if 'status' in config.PATIENTS_BY_PROVIDER_ADDL_FIELDS %}
                        <td>{%if patient.assessment_status and patient.assessment_status != "undetermined"%}{{ patient.assessment_status }}{% endif%}</td>
                      {% endif %}
                      <td><!--consent datefield--></td>
                      <td>{% for org in patient.organizations | sort(attribute='id') %}<span class="smaller-text">{{org.name}}</span><br/>{% endfor %}</td>
                  </tr>
               {% endfor %}
          </tbody>
      </table>
  </div>
</div>
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}
{% block document_ready %}

var leafOrgs = {% if leaf_organizations %} {{ leaf_organizations | safe}} {% else %} false {% endif %};
var org_list = {};
{% if org_list %}
  {% for org in org_list %}
      org_list[{{org}}] = true;
  {% endfor %}
{% endif %}

function handleOrgsListDropDown(obj) {
  if (!obj) obj = $("#orglist-dropdown");
  if ($("#org-menu").is(":visible")) {
    $(obj).find("span.glyphicon-menu-down").show();
    $(obj).find("span.glyphicon-menu-up").hide();
  } else {
    $(obj).find("span.glyphicon-menu-down").hide();
    $(obj).find("span.glyphicon-menu-up").show();
  };
};

$(document).ready(function() {
  
  $("#adminTable").on("page-change.bs.table sort.bs.table toggle.bs.table", function() {
      AT.updateData();
   });
  setTimeout(AT.updateData, 0);

  $(".tnth-admin-table").bootstrapTable({
    formatShowingRows: function (pageFrom, pageTo, totalRows) {
        var thisId = $(this).attr("tableId");
        var rowInfo = "Showing "+pageFrom+" to "+pageTo+" of "+totalRows+" users";
        $("#tableCount"+thisId).html(rowInfo);
        return rowInfo;
    }
  });
  $("input[data-field='id']:checkbox").hide();

  $(document).delegate("#patientsDownloadButton", "click", function(event){
    var instruments = "";
    $("input[name='instrument'").each(function() {
        if ($(this).is(":checked")) {
          instruments += (instruments != "" ? "&": "") + "instrument_id="+$(this).val();
        };
    });
    if (instruments != "") {
        //alert(instruments)
        $("#_downloadMessage").text("");
        $("#_downloadLink").attr("href", "/api/patient/assessment?" + instruments);
        $("#_downloadLink")[0].click();
        //$("#dataDownloadModal").modal("hide");
    } else {
        $("#_downloadMessage").text("Please choose at least one instrument.");
    };
  });

  $("input[name='instrument']").on("click", function() {
      if ($(this).is(":checked")) $("#_downloadMessage").text("");
  });

  {% if config.PROVIDER_BULK_DATA_ACCESS %}
    AT.initOrgsList({{user.id}}, leafOrgs, (/org_list/.test(location.href) ? org_list : null));
    $("#orglist-dropdown").on("click", function() {
      handleOrgsListDropDown(this);
    });
    $("html").on("click", function() {
      handleOrgsListDropDown();
    });
  {% endif %}

});

{% endblock %}

