{% extends "layout.html" %}
{% block main %}
{% from "flask_user/_macros.html" import back_btn %}

{% if current_user.has_role('admin') and HTTP_REFERER in request.environ and request.environ.HTTP_REFERER.endswith("admin") %}
{{ back_btn('admin','User List') }}
{% endif %}

<div id="loadingIndicator" class="loading-indicator">
    <i class="fa fa-circle-o-notch fa-spin fa-4x"></i><br />
    <p class="lead">{{ _("Saving") }}...</p>
</div>

<h3 class="tnth-headline">
{% if current_user.has_role('admin')%}
{{ _("Profile for") }} {{ user.username }}
{% else %}
{{ _("My TrueNTH Profile") }}
{% endif %}
</h3>

<form id="profileForm" class="form tnth-form form-with-floats" role="form">

<div class="row" style="position: relative;">
    <div class="col-md-9">

        {% if user.image_url %}
        <div class="row">
            <div class="col-xs-12">
                <div class="profile-img hidden-xs">
                    <img src="{{ user.image_url }}" />
                </div>
            </div>
        </div>
        {% endif %}

        <input type="hidden" name="birthDate" id="birthday" value="{{ user.birthdate if user.birthdate }}">
        <div class="row">
            <div class="col-xs-6">
                <div class="form-group float-input-label">
                    <label for="email">{{ _("First Name") }}</label>
                    <input required="required" data-error="{{ _('First name is required') }}" class="form-control float-text" id="firstname" name="firstname" placeholder="{{ _('First Name') }}" value="{{ user.first_name if user.first_name }}" type="text" />
                    <div class="help-block with-errors"></div>
                </div>
            </div>
            <div class="col-xs-6">
                <div class="form-group float-input-label">
                    <label for="email">{{ _("Last Name") }}</label>
                    <input required="required" data-error="{{ _('Last name is required') }}" class="form-control float-text" name="lastname" placeholder="{{ _('Last Name') }}" value="{{ user.last_name if user.last_name }}" type="text" />
                    <div class="help-block with-errors"></div>
                </div>
            </div>
        </div>

        <div class="form-group" id="bdGroup">
            <label>{{ _("Birth Date") }}</label>
            <div class="row">
                <div class="col-xs-4">
                    <input class="form-control bd-element" id="date" name="birthdayDate" placeholder="DD" type="text" maxlength="2" data-birthday="true" required />
                </div>
                <div class="col-xs-4">
                    <select class="form-control bd-element" name="birthdayMonth" id="month" data-birthday="true" required>
                        <option value="">{{ _("Month") }}...</option>
                        <option value="01">{{ _("January") }}</option>
                        <option value="02">{{ _("February") }}</option>
                        <option value="03">{{ _("March") }}</option>
                        <option value="04">{{ _("April") }}</option>
                        <option value="05">{{ _("May") }}</option>
                        <option value="06">{{ _("June") }}</option>
                        <option value="07">{{ _("July") }}</option>
                        <option value="08">{{ _("August") }}</option>
                        <option value="09">{{ _("September") }}</option>
                        <option value="10">{{ _("October") }}</option>
                        <option value="11">{{ _("November") }}</option>
                        <option value="12">{{ _("December") }}</option>
                    </select>
                </div>
                <div class="col-xs-4">
                    <input class="form-control bd-element" id="year" name="birthdayYear" placeholder="YYYY" type="text" maxlength="4" data-birthday="true" required />
                </div>
            </div>
            <span id="errorbirthday" class="help-block" style="display: none">A block of help text that breaks onto a new line and may extend beyond one line.</span>
        </div>
        <div class="form-group">
            <label>{{ _("Gender") }}</label>
            <div style="margin-top: -10px">
                <label class="radio-inline">
                    <input type="radio" name="sex" id="sexM" value="male" required {{ "checked" if user.gender == "male"}}/>
                    {{ _("Male") }}
                </label>
                <label class="radio-inline">
                    <input type="radio" name="sex" id="sexF" value="female" required {{ "checked" if user.gender == "female"}}/>
                    {{ _("Female") }}
                </label>
                <label class="radio-inline">
                    <input type="radio" name="sex" id="sexO" value="other" required {{ "checked" if user.gender == "other"}}/>
                    {{ _("Other") }}
                </label>
            </div>
        </div>
        <div class="form-group float-input-label" id="emailGroup">
            <label for="email">{{ _("Email address") }}</label>
            <input type="text" class="form-control" id="email" name="email" value="{{ user.email if user.email }}" data-customemail="true" required>
            <div class="help-block with-errors"></div>
        </div>
        <div class="form-group float-input-label">
            <label for="phone">{{ _("Cell") }} <span class="text-muted smaller-text">({{ _("Optional") }})</span></label>
            <input type="text" class="form-control" id="phone" name="phone" value="{{ user.phone if user.phone }}">
        </div>

        <p id="saveMsg" class="text-muted text-center bg-warning" style="display: none"><small>{{ _("You've updated your profile. Click the Save button to submit your changes. Or") }} <a href="">{{ _("cancel") }}</a>.</small></p>
        <p id="errorMsg" class="text-muted text-center bg-danger" style="display: none"><small>{{ _("Oops, looks like there's a problem with your profile. Please correct it before saving.") }}</small></p>
        <button id="updateProfile" type="submit" class="btn btn-lg btn-tnth-primary">{{ _("Save") }}</button>

    </div>

        <!--
        <div class="col-md-4 pos-bottom-md">
        <div id="patientQuestions">
            <div class="form-group">
                <label>Have you had a prostate cancer biopsy?</label>
                <div>
                    <label class="radio-inline">
                        <input class="history-q" type="radio" name="biopsy" value="true" />
                        Yes
                    </label>
                    <label class="radio-inline">
                        <input type="radio" name="biopsy" value="false" />
                        No
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>Have you been diagnosed with prostate cancer?</label>
                <div>
                    <label class="radio-inline">
                        <input type="radio" name="pca_diag" value="true" />
                        Yes
                    </label>
                    <label class="radio-inline">
                        <input type="radio" name="pca_diag" value="false" />
                        No
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>Have you begun prostate cancer treatment?</label>
                <div>
                    <label class="radio-inline">
                        <input type="radio" name="tx" value="true" />
                        Yes
                    </label>
                    <label class="radio-inline">
                        <input type="radio" name="tx" value="false" />
                        No
                    </label>
                </div>
            </div>
        </div>
        <div class="visible-lg"><br /></div>
        </div>
        -->
</div>


<hr />

{% if current_user.has_role('admin') and not user.has_role('service') %}
<h3>{{ _("User Roles for") }} {{ user.username }}</h3>
<div id="rolesGroup">
    <div class="form-group">
        <p>{{ _("Editable by admins only.") }}</p>
        <div class="checkbox">
            <label>
                <input type="checkbox" value="admin"> {{ _("Admin") }}
            </label>
        </div>
        <div class="checkbox">
            <label>
                <input type="checkbox" value="anon"> {{ _("Anon") }}
            </label>
        </div>
        <div class="checkbox">
            <label>
                <input type="checkbox" value="application_developer"> {{ _("Application Developer") }}
            </label>
        </div>
        <div class="checkbox">
            <label>
                <input type="checkbox" value="partner"> {{ _("Partner") }}
            </label>
        </div>
        <div class="checkbox">
            <label>
                <input type="checkbox" value="patient"> {{ _("Patient") }}
            </label>
        </div>
        <div class="checkbox">
            <label>
                <input type="checkbox" value="test"> {{ _("Test") }}
            </label>
        </div>
    </div>

</div>
{% endif %}

</form>

{% endblock %}
{% block document_ready %}
$(document).ready(function(){

var showClass = "show"
// Not using "on" class at the moment
var onClass = "on"
$(".form-with-floats .form-group > label").each(function(){
    console.log($(this))
    var label = $(this)
    setTimeout(function() {
        label.addClass("after-load")
    }, 300)
})
$(".float-input-label > input").bind("checkval",function(){
    var label = $(this).prev("label")
    if(this.value !== ""){
        label.addClass(showClass);
    } else {
        label.removeClass(showClass);
    }
}).on("keyup",function(){
    $(this).trigger("checkval")
}).on("focus",function(){
    $(this).prev("label").addClass(onClass)
}).on("blur",function(){
    $(this).prev("label").removeClass(onClass)
}).trigger("checkval");

    /*** Field Validation ***/
    $('#profileForm').validator({
        custom: {
            birthday: function() {
                var m = parseInt($("#month").val());
                var d = parseInt($("#date").val());
                var y = parseInt($("#year").val());
                // If all three have been entered, run check
                var goodDate = false;
                var errorMsg = "Sorry, this isn't a valid date. Please try again.";
                if (m && d && y) {
                    var today = new Date();
                    // Check to see if this is a real date
                    var date = new Date(y,m-1,d);
                    if (date.getFullYear() == y && date.getMonth() + 1 == m && date.getDate() == d) {
                        goodDate = true;
                        // Only allow if birthdate is before today
                        if (date.setHours(0,0,0,0) >= today.setHours(0,0,0,0)) {
                            goodDate = false;
                            errorMsg = "Your birthdate must be in the past.";
                        }
                    }
                    if (y.toString().length < 3) {
                        goodDate = false;
                        errorMsg = "Please make sure you use a full 4-digit number for your birth year.";
                    }
                    // After tests display errors if necessary
                    if (goodDate) {
                        $("#errorbirthday").hide();
                        // Set date if YYYY-MM-DD
                        $("#birthday").val(y+"-"+m+"-"+d);
                    } else {
                        $("#errorbirthday").html(errorMsg).show();
                        $("#birthday").val("");
                    }
                } else {
                    // If NaN then the values haven't been entered yet, so we
                    // validate as true until other fields are entered
                    if (isNaN(y) || (isNaN(d) && isNaN(y))) {
                        return true;
                    } else if (isNaN(d)) {
                        errorMsg = "Please enter a date.";
                    }
                    $("#errorbirthday").html(errorMsg).show();
                    $("#birthday").val("");
                }
                if (goodDate) {
                    return true;
                } else {
                    return false;
                }

            },
            customemail: function($el) {
                if ($el.val() == "") {
                    return false;
                }
                var emailReg = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                return emailReg.test( $el.val() );
            }
        },
        errors: {
            birthday: "Sorry, this isn't a valid date. Please try again.",
            customemail: "This isn't a valid e-mail address, please double-check."
        },
        disable: false
    });
    // If there's any change to form fields, the note that
    $("#profileForm :input").change(function() {
        $(this).closest('form').attr('data-changed', true)
    });
    $('#profileForm').on('validated.bs.validator', function(e) {
        var validator = $(this).data('bs.validator');
        // If the form has a change, then show save or error messages
        if ($(this).data('changed')) {
            if (!validator.hasErrors()) {
                $("#saveMsg").fadeIn("slow")
                $("#errorMsg").hide()
            } else {
                $("#saveMsg").hide()
                $("#errorMsg").fadeIn("slow")
            }
        }
    })
    /*** End -- Field Validation ***/

    // Fill in 3 birthday fields based on existing value - requires date format YYYY-MM-DD
    var currentBd = $("#birthday").val();
    if (currentBd) {
        var bdArray = currentBd.split("-");
        $("#year").val(bdArray[0]);
        $("#month").val(bdArray[1]);
        $("#date").val(bdArray[2]);
    }

    // Submit the form here
    $("#updateProfile").on("click", function(event){
        event.preventDefault()

        $("#profileForm").addClass("loading");
        $("#loadingIndicator").show();

        // Grab profile field values
        var getBirthday = $("input[name=birthDate]").val()
        var getFirstname = $("input[name=firstname]").val()
        var getLastname = $("input[name=lastname]").val()
        var getSex = $("input[name=sex]:checked").val()
        var getEmail = $("input[name=email]").val()
        var getPhone = $("input[name=phone]").val()

        // Put form data into FHIR array
        var demoArray = {};
        demoArray["resourceType"] = "Patient"
        demoArray["birthDate"] = getBirthday
        demoArray["gender"] = getSex
        demoArray["name"] = {
            "given": getFirstname,
            "family": getLastname
        };
        demoArray["telecom"] = [
            { "system": "email", "value": getEmail },
            { "system": "phone", "value": getPhone }
        ];
        /** Send the AJAX **/
        $.ajax ({
            type: "PUT",
            url: '/api/demographics/{{ user.id }}',
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: JSON.stringify(demoArray)
        }).done(function() {
            $("#saveMsg").hide()
            setTimeout(function(){
                $("#profileIntro").html("<strong>Your changes have been saved.</strong> Return to the <a href='/'>main portal page</a> {% if current_user.has_roles('admin') %} or <a href='/admin'> user administration</a>{% endif %}.");
                $("#profileForm").removeClass("loading");
                $("#loadingIndicator").fadeOut();
            }, 1200);
        }).fail(function() {
            alert("There was a problem updating your profile. Please try again.");
            $("#loadingIndicator").fadeOut();
            $("#profileForm").removeClass("loading");
        }); 
    });
});

/** Remove patientQuestion functionality for now
var getQs = [ "biopsy", "pca_diag", "tx"];
$.each(getQs, function(i,val){
    $.ajax ({
        type: "GET",
        url: '/api/patient/{{ user.id }}/clinical/'+val
    }).done(function(data) {
        var $radios = $('input:radio[name='+val+']');
        if($radios.is(':checked') === false) {
            $radios.filter('[value='+data.value+']').prop('checked', true);
        }
    }).fail(function() {
        console.log("Problem retrieving data from server.")
    });
});
$("#patientQuestions input").on("change", function(){
    var toCall = $(this).attr("name");
    var theVal = $(this).val();
    $.ajax ({
        type: "POST",
        url: '/api/patient/{{ user.id }}/clinical/'+toCall,
        contentType: "application/json; charset=utf-8",
        dataType: 'json',
        data: JSON.stringify({value: theVal})
    }).done(function() {
        // Allow user to save with button, even though these answers have already been submitted
        $('#updateProfile').removeClass("disabled")
    }).fail(function() {
        alert("There was a problem saving your answers. Please try again.");
    });
});
**/
// GET and PUT user roles
$.ajax ({
    type: "GET",
    url: '/api/user/{{ user.id }}/roles'
}).done(function(data) {
    $.each(data.roles,function(i,val){
        $("#rolesGroup input:checkbox[value="+val.name+"]").prop('checked', true);
    })
}).fail(function() {
    console.log("Problem retrieving data from server.")
});

$("#rolesGroup input:checkbox").on("click",function(){
    var roles = []
    roles.push({name: $(this).val()})
    var toSend = {"roles": roles}
    // If role is checked, type is PUT, otherwise DELETE
    var ajaxType = "DELETE"
    if ($(this).prop('checked')) {
        ajaxType = "PUT"
    }
    $.ajax ({
        type: ajaxType,
        url: '/api/user/{{ user.id }}/roles',
        contentType: "application/json; charset=utf-8",
        dataType: 'json',
        data: JSON.stringify(toSend)
    }).done(function(data) {
    }).fail(function() {
        console.log("Problem updating role on server.")
    })
})
{% endblock %}
