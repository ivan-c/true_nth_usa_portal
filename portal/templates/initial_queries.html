{% extends "layout.html" %}
{% block main %}
{% from "flask_user/_macros.html" import back_btn %}

  <div id="loadingIndicator" class="loading-indicator">
    <i class="fa fa-circle-o-notch fa-spin fa-4x"></i>
  </div>

  <h3 class="tnth-headline">About You</h3>

  <p>Thanks for signing up for TrueNTH. Please finish your registration by telling us about yourself.</p>
  <hr />

  <form class="form tnth-form" id="queriesForm" action='initial-queries' method='POST'>

    <p>First, tell us who you are:</p>

    <div class="row" id="nameBox">
      <div class="col-xs-6">
        <div class="form-group float-input-label">
          <input class="form-control float-text" id="firstname" name="firstname" placeholder="First Name" type="text" />
          <div class="help-block with-errors"></div>
        </div>
      </div>
      <div class="col-xs-6">
        <div class="form-group float-input-label">
          <input class="form-control float-text" id="lastname" name="lastname" placeholder="Last Name" type="text" />
          <div class="help-block with-errors"></div>
        </div>
      </div>
    </div>
    <div class="form-group" id="userRoles">
      <div class="radio">
        <label>
          <input type="radio" name="user_type" value="patient"> I'm a man who is concerned about prostate cancer for myself
        </label>
      </div>
      <div class="radio">
        <label>
          <input type="radio" name="user_type" value="partner"> I'm a caregiver, spouse or partner who wants to learn more about prostate cancer
        </label>
      </div>
    </div>


    <input type="hidden" name="birthDate" id="birthday" value="">

    <div class="form-group tnth-hide" id="bdGroup">
      <label>Birth Date</label>
      <div class="row">
        <div class="col-xs-4">
          <select class="form-control bd-element" name="birthdayMonth" id="month" data-birthday="true" required>
            <option value="">Month...</option>
            <option value="01">January</option>
            <option value="02">February</option>
            <option value="03">March</option>
            <option value="04">April</option>
            <option value="05">May</option>
            <option value="06">June</option>
            <option value="07">July</option>
            <option value="08">August</option>
            <option value="09">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>
        <div class="col-xs-4">
          <input class="form-control bd-element" id="date" name="birthdayDate" placeholder="DD" type="text" maxlength="2" data-birthday="true" required />
        </div>
        <div class="col-xs-4">
          <input class="form-control bd-element" id="year" name="birthdayYear" placeholder="YYYY" type="text" maxlength="4" data-birthday="true" required />
        </div>
      </div>
      <span id="bdError" class="help-block" style="display: none">A block of help text that breaks onto a new line and may extend beyond one line.</span>
    </div>


    <div class="tnth-hide" id="patientQ">

      <div id="patBiopsy" data-topic="biopsy" class="pat-q">
        <br />
        <p>Have you had a prostate cancer biopsy?</p>
        <div class="form-group">
          <div class="radio">
            <label>
              <input type="radio" name="biopsy" value="true"> Yes
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" name="biopsy" value="false"> No
            </label>
          </div>
        </div>
      </div>

      <div id="patDiag" data-topic="pca_diag" class="tnth-hide pat-q">
        <br />
        <p>Have you been diagnosed with prostate cancer?</p>
        <div class="form-group">
          <div class="radio">
            <label>
              <input type="radio" name="pca_diag" value="true"> Yes
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" name="pca_diag" value="false"> No
            </label>
          </div>
        </div>
      </div>

      <div id="patMeta" data-topic="pca_metastasize" class="tnth-hide pat-q">
        <br />
        <p>Is the prostate cancer only within the prostate?</p>
        <div class="form-group">
          <div class="radio">
            <label>
              <input type="radio" name="pca_metastasize" value="true"> Yes
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" name="pca_metastasize" value="false"> No (the cancer is in other parts of my body, too)
            </label>
          </div>
        </div>
      </div>

      <div id="patTx" data-topic="tx" class="tnth-hide pat-q">
        <br />
        <p>Have you begun prostate cancer treatment?</p>
        <div class="form-group">
          <div class="radio">
            <label>
              <input type="radio" name="tx" value="true"> Yes
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" name="tx" value="false"> No
            </label>
          </div>
        </div>
      </div>

    </div>

    <div id="clinics" class="tnth-hide">

      <h3 class="tnth-headline">Your Clinic</h3>

      <p>Where are you receiving your care?</p>

      <div class="form-group" id="userOrgs">
        <div style="margin-left: 10px">

          <legend style="margin: 0  0 4px">UCSF</legend>
          <input class="tnth-hide" type="checkbox" name="organization" value="5"/>
          <div class="form-group" id="clinics5">
          </div>
          <legend style="margin: 0  0 4px">UW Medicine</legend>
          <input class="tnth-hide" type="checkbox" name="organization" value="1"/>
          <div class="form-group" id="clinics1">
          </div>
          <div style="margin: 0.5em 0" class="checkbox"><label><input id="noOrgs" class="clinic" type="checkbox" name="organization" value="0">None of the Above</label></div>
        </div>

        <div id="saveOrgs" class="btn btn-tnth-primary">Save My Clinics</div>
      </div>

    </div>

    <div id="terms" class="tnth-hide">

      <h3 class="tnth-headline">Terms of Use</h3>

      <p>OK, please review the terms of use for TrueNTH:</p>

      <div class="well" style="margin-left: 2em">
        <p class="text-muted">[Terms of use present as scrolling textbox or trigger modal via "Review" button. Need to decide what happens if user does not agree.]</p>

        <div id="termsAgree" class="btn btn-tnth-primary">I Agree</div>
      </div>
    </div>
    <br />
    <p class="tnth-hide" id="continueText">Great! Click continue to start using TrueNTH.</p>
    <br />
    <button id="updateProfile" type="submit" class="btn btn-lg btn-tnth-primary" disabled>Continue to TrueNTH</button>
  </form>


{% endblock %}
{% block document_ready %}
$(document).ready(function(){

  /** 1st - get all current info **/
  tnthAjax.getRoles({{ user.id }});
  tnthAjax.getOrgs({{ user.id }});
  tnthAjax.getClinical({{ user.id }});

  /** 2nd - submit changes and update UI **/
  $("#queriesForm input").on("blur",function(){
    assembleContent.demo({{ user.id }});
  });
  $("#userRoles input:radio").on("click",function(){
    $.each($("#userRoles input:radio"), function() {
      var roles = [];
      var theVal = $(this).val();
      roles.push({name: theVal});
      var toSend = {"roles": roles};
      if ($(this).is(":checked")) {
        tnthAjax.putRoles({{user.id}},toSend);
        if (theVal == "patient") {
          $("#patientQ").fadeIn();
          $("#bdGroup").fadeIn();
          $("#clinics").hide();
        } else {
          // If partner, they skip questions, fadeIn Clinics
          $("#clinics").fadeIn();
          $("#patientQ").hide();
          $("#bdGroup").hide();
        }
      } else {
        tnthAjax.deleteRoles({{user.id}},toSend);
      }
    });
  });

  $(".pat-q input:radio").on("click",function(){
    var thisItem = $(this);
    var toCall = thisItem.attr("name")
    // Get value from div - either true or false
    var toSend = thisItem.val();
    tnthAjax.putClinical({{user.id}},toCall,toSend);
    if (toSend == "true" || toCall ==  "pca_metastasize") {
      thisItem.parents(".pat-q").next().fadeIn();
      if (toCall == "tx") {
        $("#clinics").fadeIn();
      }
    } else {
      if (toCall == "biopsy") {
        tnthAjax.putClinical({{user.id}},"pca_diag","false");
        tnthAjax.putClinical({{user.id}},"pca_metastasize","false");
        tnthAjax.putClinical({{user.id}},"tx","false");
      } else if (toCall == "pca_diag") {
        tnthAjax.putClinical({{user.id}},"pca_metastasize","false");
        tnthAjax.putClinical({{user.id}},"tx","false");
      }
      $("#clinics").fadeIn();
    }
  });

  // Handling "none of the above" clinic choice
  $("#clinics").on("click", ".clinic", function(){
    if ($(this).prop('checked')){
      if ($(this).attr("id") !== "noOrgs") {
        $("#noOrgs").attr('checked',false);
      } else {
        $("input[name='organization']:not(#noOrgs)").attr('checked',false);
      }
    }
  });
  /**
  $("#clinics").on("change", ".clinic", function() {
    console.log($(this).val());
    console.log($(this).is(":checked"));
    //assembleContent.orgs2({{ user.id }}, $(this).val(), $(this).is(":checked"));
  });
  **/

  $("#saveOrgs").on("click",function(){
    assembleContent.orgs({{ user.id }});
    $("#terms").fadeIn();
  });

  $("#termsAgree").on("click",function(){
    $("#continueText").fadeIn();
    $("#updateProfile").removeAttr("disabled");
  });

});
{% endblock %}


