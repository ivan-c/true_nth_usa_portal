{% extends "layout.html" %}
{% block main %}
{% from "flask_user/_macros.html" import back_btn %}

{% from "initial_queries_macros.html" import tou, nameGroup, rolesGroup, dobGroup, patientQGroup, clinic, consent %}


  <!-- <div id="loadingIndicator" class="loading-indicator">
    <i class="fa fa-circle-o-notch fa-spin fa-4x"></i>
  </div> -->
  <input type="hidden" id="iq_userId" value="{{user.id}}" />

  {% if 'tou' in still_needed %}
    {{tou(terms)}}
  {% endif %}

  <div id="aboutForm" class="tnth-hide">
     <form class="form tnth-form to-validate" id="queriesForm" action='initial-queries' method='POST'>
        {% if 'name' in still_needed or 'role' in still_needed or 'dob' in still_needed or 'clinical' in still_needed or 'org' in still_needed%}
          <h3 class="tnth-headline">{{ _("About You") }}</h3>

          <p class="profile-item-title">{{ _("Thank You! Now, please finish your registration by telling us about yourself.") }}</p>

            <!--<p>First, tell us who you are:</p>-->
            {% if user and user._email %}
                <input type="hidden" name="email" id="email" value="{{user._email}}" />
            {% endif %}
            {% if 'name' in still_needed %}
              {{nameGroup()}}
            {% else %}
                {% if user and user.first_name and user.last_name %}
                  <p>{{ _("Your") }} <em>{{ _("Name") }}</em>: {{user.first_name}} {{user.last_name}}</p>
                  <br/>
                  <input type="text" name="firstname" id="fistname" value="{{user.first_name}}" style="display:none"/>
                  <input type="text" name="lastname" id="lastname" value="{{user.last_name}}" style="display:none"/>
                {% endif %}
            {% endif %}
            {% if 'role' in still_needed %}
              {{rolesGroup()}}
            {% endif %}
            {% if 'dob' in still_needed %}
              {{dobGroup()}}
            {% else %}
                {% if user and user.birthdate %}
                  <input type="hidden" name="birthDate" id="birthday" value="{{user.birthdate}}">
                {% endif %}
            {% endif %}
            {% if 'clinical' in still_needed %}
              {{patientQGroup(user)}}
            {% endif %}
            {% if 'org' in still_needed %}
              {{clinic(consent_agreements)}}
            {% endif %}
            <br />
            <p class="tnth-hide" id="continueText">{{ _("Great! Click continue to start using TrueNTH.") }}</p>
            <br />
            <button id="updateProfile" type="submit" class="btn btn-lg btn-tnth-primary" disabled>{{ _("Continue to TrueNTH") }}</button>
        {% else %}
          <style>
          .reg-complete-container {
            width: 100%;
            max-width: 100%;
            margin: 10% auto;
            background-color: #f8f8f9;
            padding: 2em 2em 2.7em 2em;
            text-align: center;
            border-radius: 8px;
          }
          </style>
           <div class="reg-complete-container">
              <h4 class="profile-item-title"> {{ _("Thank you for registering.") }}</h4>
              <p>{{ _("Click continue to start using TrueNTH") }}</p>
              <br/>
              <button id="updateProfile" type="submit" class="btn btn-lg btn-tnth-primary" disabled>{{ _("Continue to TrueNTH") }}</button>
           </div>
        {% endif %}

  </form>
  </div>

{% endblock %}
{% block document_ready %}

// Check if there's a session variable for associated clinic
var preselectClinic = "{{ session.get('associate_clinic_id') }}";
var fc, incompleteFields = [], mainSections = {}, _isChecked = false, rolesGroupClickEvent, patientQClickEvent, userOrgChangeEvent;

/***** helper class to keep track of missing fields ***/
var FieldsChecker = function(mainSections) {
  this.mainSections = mainSections;
  this.incompleteFields = [];
  this.skipped = false;
};

FieldsChecker.prototype.getIncompleteFields = function() {
  return this.incompleteFields;
};

FieldsChecker.prototype.setIncompleteFields = function() {
  var self = this;
  if (this.mainSections) {
    var ms = this.mainSections;
    self.reset();
    for (var section in ms) {
      var fields = ms[section].fields;
      fields.forEach(function(field) {
          if (field.length > 0) {
            var type = field.attr('type');
            switch(String(type).toLowerCase()) {
            case 'checkbox':
                  _isChecked = false;
                  field.each(function() {
                      if ($(this).is(":checked")) {
                        _isChecked = true;
                      };
                  });
                  if (!(_isChecked)) self.incompleteFields.push({'sectionId': section, 'section': $('#'+ section), 'element':field});
                  break;
            case 'radio':
                if (!field.is(":checked")) self.incompleteFields.push({'sectionId': section,'section': $('#'+ section), 'element':field});
                break;
            case 'select':
            case 'text':
                if (field.val() == '') self.incompleteFields.push({'sectionId': section,'section': $('#' + section), 'element': field});
                break;
            };
          };
      });
    };

    self.incompleteFields.forEach(function(field, index) {
      var fe = field.element;
      fe.each(function() {
          var f = $(this);
          f.attr('sectionIndex', index);
      });
    });

  };
};

FieldsChecker.prototype.reset = function() {
    var self = this;
    self.incompleteFields.forEach(function(field) {
      var fe = field.element;
      fe.each(function() {
          var f = $(this);
          f.removeAttr('sectionIndex');
      });
    });
    self.incompleteFields = [];
};

FieldsChecker.prototype.getNextField = function(currentIndex) {
    currentIndex = parseInt(currentIndex);
    if (!isNaN(currentIndex) && currentIndex >= 0) {
      if ((currentIndex + 1) <= (this.incompleteFields.length - 1)) {
          this.incompleteFields[currentIndex + 1].section.show();
          var el = this.incompleteFields[currentIndex + 1].element;
           el.fadeIn();
           $('html, body').animate({
              scrollTop: el.offset().top
           }, 500);
      };
    };
};

FieldsChecker.prototype.allFieldsCompleted = function() {
  this.setIncompleteFields();
  return this.incompleteFields.length == 0;
};


function continueOn() {
  $("#continueText").fadeIn();
  $("#updateProfile").removeAttr("disabled");
};

function initIncompleteFields() {

  fc.setIncompleteFields();
  incompleteFields = fc.getIncompleteFields();
  incompleteFields.forEach(function(field, index) {

    var fe = field.element;

    fe.each(function() {
        var f = $(this);
        var triggerEvent = ($(f).attr("type") == "text" ? "change" : "click");
        if (f.get(0).nodeName.toLowerCase() == "select") triggerEvent = "change";
        var customEvent = mainSections[field.sectionId].event;

        if (customEvent) {
          f.on(triggerEvent, customEvent);
        }
        else {
            f.on(triggerEvent, function() {
                var isComplete = fc.allFieldsCompleted();
                if (isComplete) {
                   continueOn();
                }
                else {
                  //incompleteFields[parseInt($(this).attr('sectionIndex')) + 1].section.show();
                  //incompleteFields[parseInt($(this).attr('sectionIndex')) + 1].element.show();
                  fc.getNextField($(this).attr('sectionIndex'));
                };
                //console.log('field index: ' + f.attr('sectionIndex'));
                //console.log('incomplete fields length: ' + incompleteFields.length);
            });
        };
    });
  });


  if (incompleteFields.length == 0) {
      $("#updateProfile").removeAttr("disabled");
  } else {
       incompleteFields[0].section.show();
       incompleteFields[0].element.show();
  };

  /***********
  incompleteFields.forEach(function(field, index) {
      console.log(field.section.attr("id") + " " + field.element.length);
      console.log(field.element)

  });
  ********/


  //console.log("length: " + incompleteFields.length);

};


$(document).ready(function(){

    var rolesGroupClickEvent = function(){
        var roles = [];
        var theVal = $(this).val();
        roles.push({name: theVal});
        var toSend = {"roles": roles};
        tnthAjax.putRoles({{user.id}},toSend);
        if (theVal == "patient") {
          // If patient, then we always show bdGroup
          if ($("#bdGroup").length > 0) {
            $("#bdGroup").fadeIn();
          };
          // Also, if they already have a valid birthday, then trigger blur to make patientQ appear
          if ($("#year").val() != "") {
            $("#year").blur();
            if ($('#patientQ').length > 0) {
              $('#patientQ').fadeIn();
              $('html, body').animate({
                scrollTop: $('#patientQ').offset().top
              }, 500);
            } else fc.getNextField($(this).attr("sectionIndex"));
          } else {
            if ($("#bdGroup").length > 0 ) {
              $('html, body').animate({
                scrollTop: $('#bdGroup').offset().top
              }, 500);
            } else fc.getNextField($(this).attr("sectionIndex"));
          };
          //$("#clinics").hide();

        } else {
          // If partner, skip all questions
          $("#patientQ").hide();
          $("#bdGroup").hide();
          $("#noOrgs").click();
          continueOn();
        };
        if (fc.allFieldsCompleted()) continueOn();
    };

    var patientQClickEvent = function(){
          var thisItem = $(this);
          var toCall = thisItem.attr("name")
          // Get value from div - either true or false
          var toSend = thisItem.val();
          tnthAjax.putClinical({{user.id}},toCall,toSend);
          if (toSend == "true" || toCall ==  "pca_localized") {
            thisItem.parents(".pat-q").next().fadeIn();
            var nextRadio = thisItem.closest(".pat-q").next(".pat-q");
            var nextItem = nextRadio.length > 0 ? nextRadio : thisItem.parents(".pat-q").next();
            if (nextItem.length > 0) {
              $('html, body').animate({
                scrollTop: nextItem.offset().top
              }, 500);
            } else {
              if ($("#clinics").length > 0) {
                $("#clinics").fadeIn();
                $('html, body').animate({
                  scrollTop: $('#clinics').offset().top
                }, 500);
              } else fc.getNextField(thisItem.attr("sectionIndex"));
            };
          } else {
            if (toCall == "biopsy") {
              ["pca_diag", "pca_localized"].forEach(function(fieldName) {
                  $("input[name='" + fieldName + "']").each(function() {
                      $(this).prop("checked", false);
                  });
              });
              if ($("input[name='pca_diag']").length > 0) tnthAjax.putClinical({{user.id}},"pca_diag","false");
              if ($("input[name='pca_localized']").length > 0) tnthAjax.putClinical({{user.id}},"pca_localized","false");
            } else if (toCall == "pca_diag") {
              ["pca_localized"].forEach(function(fieldName) {
                  $("input[name='" + fieldName + "']").each(function() {
                      $(this).prop("checked", false);
                  });
              });
              if ($("input[name='pca_localized']").length > 0) tnthAjax.putClinical({{user.id}},"pca_localized","false");
              //tnthAjax.putClinical({{user.id}},"tx","false");
            }
            thisItem.parents(".pat-q").nextAll().fadeOut();
            if ($("#clinics").length > 0) {
              $("#clinics").fadeIn();
              $('html, body').animate({
                  scrollTop: $('#clinics').offset().top
              }, 500);
            } else continueOn();
          };

          if (fc.allFieldsCompleted()) continueOn();
      };

    var userOrgChangeEvent = function() {
      //console.log("changed?")
      assembleContent.demo({{ user.id }});
      //if (fc.allFieldsCompleted()) {
        continueOn();
      //};
    };


    $("#agreeLabel").on("click",function(){
      if ($(this).attr("data-agree") == "false") {
        var theTerms = {};
        theTerms["agreement_url"] = $("#termsURL").data().url;
        // Post terms agreement via API
        tnthAjax.postTerms(theTerms);
        // Update UI
        $(this).find("i").removeClass("fa-square-o").addClass("fa-check-square-o").end()
          .find("span").text("Yes, I agree");
        $("#aboutForm").fadeIn();
        $('html, body').animate({
          scrollTop: $('#aboutForm').offset().top
        }, 1000);
        $(this).attr("data-agree","true");
      } else {
        $(this).find("i").removeClass("fa-cehck-square-o").addClass("fa-square-o").end()
          .find("span").text("Check here to agree to these terms");
        $("#aboutForm").fadeOut();
        $(this).attr("data-agree","false");
      };
    });

    //if term of use form not present - need to show the form
    if ($("#topTerms").length == 0)  $("#aboutForm").fadeIn();

    $('#queriesForm').validator().on('submit', function (e) {
        if (e.isDefaultPrevented()) {
          alert("There's a problem with your submission. Please check your answers, then try again.  Make sure all required fields are completed.");
        } else {
          assembleContent.demo({{ user.id }});
        }
    });


    /**** main object
          this will help keeping track of missing fields
     *****/
    mainSections = {

      'nameGroup':  {
                      fields: [$("#firstname"), $("#lastname")],
                      event: null
                    },
      'rolesGroup': {
                      fields: [$("input[name='user_type']")],
                      event: rolesGroupClickEvent
                    },
      'bdGroup':    {
                      fields: [$("#month"), $("#date"), $("#year")],
                      event: null
                    },
      'patientQ':   {
                      fields: [$("input[name='biopsy']"), $("input[name='pca_diag']"), $("input[name='pca_localized']")],
                      event: patientQClickEvent
                    },
      'clinics':    {
                      fields: [$("#userOrgs input[name='organization'][data-parent-id]")],
                      event: userOrgChangeEvent
                    }
    };

    fc = new FieldsChecker(mainSections);
    setTimeout("initIncompleteFields();", 500);


    /** 1st - get all current info **/
    /***done in macros now*****/
    //tnthAjax.getRoles({{ user.id }});
    //tnthAjax.getOrgs({{ user.id }});
    //tnthAjax.getDemo({{ user.id}});
    //tnthAjax.getClinical({{ user.id }});

  /************** old consent stuff
  $("#userOrgs input[name='organization']").each(function() {
      $(this).on("click", function() {
          var parentOrg = $(this).attr("data-parent-id");
          var parentName = $(this).attr("data-parent-name");
          //console.log("parentOrg: " + parentOrg + " parentName: " + parentName);
          if (parentOrg != "") {
              if ($(this).prop("checked")) {
                  if ($("#" + parentOrg + "_consent").length > 0 && !($("#" + parentOrg + "_consent").is(":checked"))) { //only show consent checkbox if consent was not previous given
                      $("#consentContainer .consent").hide();
                      if (parentName) $("#" + parentOrg + "_consent_label").text("Share data with " + parentName + "?");
                      else $("#" + parentOrg + "_consent_label").text("Share data with this institution?");
                      $("#" + parentOrg + "_consentItem").show();
                      console.log($("#" + parentOrg + "_consentItem"))
                  };
              } else {
                  $("#consentContainer .consent").hide();
              };
          };

          $("#userOrgs").find(".help-block").text("");


      });
    });********************************/
  });
{% endblock %}


