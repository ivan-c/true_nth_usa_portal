{% extends "layout.html" %}
{% block main %}
{% from "flask_user/_macros.html" import back_btn %}

{% from "initial_queries_macros.html" import tou, nameGroup, rolesGroup, dobGroup, patientQGroup, clinic %}


  <div id="loadingIndicator" class="loading-indicator">
    <i class="fa fa-circle-o-notch fa-spin fa-4x"></i>
  </div>
  <input type="hidden" id="iq_userId" value="{{user.id}}" />

  {% if 'tou' in still_needed %}
    {{tou(terms)}}
  {% endif %}

  <div id="aboutForm" class="tnth-hide">

    <h3 class="tnth-headline">About You</h3>

    <p>Thanks! Now, please finish your registration by telling us about yourself.</p>
    <hr />

    <form class="form tnth-form to-validate" id="queriesForm" action='initial-queries' method='POST'>

      <p>First, tell us who you are:</p>

      {% if 'name' in still_needed %}
        {{nameGroup()}}
      {% endif %}
      {% if 'role' in still_needed %}
        {{rolesGroup()}}
      {% endif %}
      {% if 'dob' in still_needed %}
        {{dobGroup()}}
      {% endif %}
      {% if 'clinical' in still_needed %}
        {{patientQGroup()}}
      {% endif %}
      {% if 'org' in still_needed %}
        {{clinic()}}
      {% endif %}
   
    <br />
    <p class="tnth-hide" id="continueText">Great! Click continue to start using TrueNTH.</p>
    <br />
    <button id="updateProfile" type="submit" class="btn btn-lg btn-tnth-primary" disabled>Continue to TrueNTH</button>
  </form>

  </div>

{% endblock %}
{% block document_ready %}

// Check if there's a session variable for associated clinic
var preselectClinic = "{{ session.get('associate_clinic_id') }}";

$(document).ready(function(){

  /** 1st - get all current info **/
  /***done in macros now*****/
  //tnthAjax.getRoles({{ user.id }});
  //tnthAjax.getOrgs({{ user.id }});
  //tnthAjax.getDemo({{ user.id}});
  //tnthAjax.getClinical({{ user.id }});

  /** 2nd - submit changes and update UI **/
  $("#queriesForm input").on("blur",function(){
    assembleContent.demo({{ user.id }});
  });


  $("#rolesGroup input:radio").on("click",function(){
      var roles = [];
      var theVal = $(this).val();
      roles.push({name: theVal});
      var toSend = {"roles": roles};
      tnthAjax.putRoles({{user.id}},toSend);
      if (theVal == "patient") {
        // If patient, then we always show bdGroup
        $("#bdGroup").fadeIn();
        // Also, if they already have a valid birthday, then trigger blur to make patientQ appear
        if ($("#year").val() != "") {
          $("#year").blur();
          $('html, body').animate({
            scrollTop: $('#patientQ').offset().top
          }, 500);
        } else {
          $('html, body').animate({
            scrollTop: $('#bdGroup').offset().top
          }, 500);
        }
        $("#clinics").hide();
      } else {
        // If partner, they skip questions, fadeIn Clinics
        $("#clinics").fadeIn();
        $("#patientQ").hide();
        $("#bdGroup").hide();
        $('html, body').animate({
          scrollTop: $('#clinics').offset().top
        }, 500);
      };
  });

  $(".pat-q input:radio").on("click",function(){
      var thisItem = $(this);
      var toCall = thisItem.attr("name")
      // Get value from div - either true or false
      var toSend = thisItem.val();
      tnthAjax.putClinical({{user.id}},toCall,toSend);
      if (toSend == "true" || toCall ==  "pca_localized") {
        thisItem.parents(".pat-q").next().fadeIn();
        if (toCall == "tx") {
          $("#clinics").fadeIn();
        }
      } else {
        if (toCall == "biopsy") {
          tnthAjax.putClinical({{user.id}},"pca_diag","false");
          tnthAjax.putClinical({{user.id}},"pca_localized","false");
          tnthAjax.putClinical({{user.id}},"tx","false");
        } else if (toCall == "pca_diag") {
          tnthAjax.putClinical({{user.id}},"pca_localized","false");
          tnthAjax.putClinical({{user.id}},"tx","false");
        }
        thisItem.parents(".pat-q").nextAll().fadeOut();
        $("#clinics").fadeIn();
      };
  });

  $("#userOrgs").on("change", "input", function() {
      assembleContent.orgs({{ user.id }});
      $("#continueText").fadeIn();
      $("#updateProfile").removeAttr("disabled");
  });

  $("#agreeLabel").on("click",function(){
      if ($(this).attr("data-agree") == "false") {
        var theTerms = {};
        //theTerms["text"] = $(this).attr('data-terms');
        // Grab the current text of the Terms of Use
        theTerms["text"] = $("#termsText").text();
        // Post terms agreement via API
        tnthAjax.postTerms(theTerms);
        // Update UI
        $(this).find("i").removeClass("fa-square-o").addClass("fa-check-square-o").end()
          .find("span").text("Yes, I agree");
        $("#aboutForm").fadeIn();
        $('html, body').animate({
          scrollTop: $('#aboutForm').offset().top
        }, 1000);
        $(this).attr("data-agree","true");
      } else {
        $(this).find("i").removeClass("fa-cehck-square-o").addClass("fa-square-o").end()
          .find("span").text("Check here to agree to these terms");
        $("#aboutForm").fadeOut();
        $(this).attr("data-agree","false");
      };
  });

  //if term of use form not present - need to show the form
  if ($("#topTerms").length == 0)  $("#aboutForm").fadeIn();

  $('#queriesForm').validator().on('submit', function (e) {
      if (e.isDefaultPrevented()) {
        alert("There's a problem with your submission. Please check your answers, then try again.");
      };
  });

});
{% endblock %}


