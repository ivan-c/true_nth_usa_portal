{% extends "layout.html" %}
{% block main %}
{% from "flask_user/_macros.html" import back_btn, back_link %}
{% from "profile_macros.html" import profile, profileSaveBtn, profileImage %}

<!-- <div id="loadingIndicator" class="loading-indicator">
    <i class="fa fa-circle-o-notch fa-spin fa-4x"></i>
</div> -->

<br/>

<div class="profile-header">
    {% if providerPerspective == 'true' %}
        <h4 class="tnth-headline">Patient Profile</h4><h4 class="profile-item-title">#{{ user.id}} - {{ user.username }}</h4>
    {% elif current_user.has_role('admin') %}
        <h4 class="tnth-headline">Profile for {{ user.username }}</h4>
    {% else %}
         <h4 class="tnth-headline">My TrueNTH Profile</h4>
    {% endif %}

    {{profileImage(user)}}
</div>

<div id="indexNavBar">
{% if providerPerspective == 'true' %}
{{ back_link('patients','Patients List') }}
{% elif current_user.has_role('admin') and request.environ.HTTP_REFERER and request.environ.HTTP_REFERER.endswith("admin") %}
{{ back_link('admin','User List') }}
{% else %}
{{ back_link(PORTAL,'Home') }}
{% endif %}
<span class="glyphicon index-list glyphicon-list" data-toggle="tooltip" data-placement="top" title="index list"></span>
</div>
<div id="indexContainer">Index List</div>
<br/>
<form id="profileForm" class="form tnth-form to-validate" role="form">

<div class="row" style="position: relative;">
    <div class="col-md-12">
        {{profile(user, current_user, consent_agreements)}}
        <br/>
        {% if providerPerspective == 'true' %}
           <br/><br/> {{ back_btn('patients','Patients List') }}
        {% else %}
            <br/><br/><a href="{{PORTAL}}/home" class="btn btn-xs btn-tnth-back"><small><b>&lt;</b> Back to Home</small></a>
        {% endif %}
    </div>
</div>
</form>

{% endblock %}

{% block document_ready %}

function goTo(event, id) {
    event.stopPropagation();
    window.location = "#" + id;
    $("#indexContainer").removeClass("open");
};

$(document).ready(function(){


    $("#clinics input[name='organization']").each(function() {

        var parentOrg = $(this).attr("data-parent-id");

        if (parentOrg != "") {
            if ($(this).is(":checked")) {
               $("#" + parentOrg + "_consentItem").show();
            };
        };

    });

    [{
        attachID: "month",
        targetField: $("#month")
     },
     {
        attachID: "date",
        targetField: $("#date")
     },
     {
        attachID: "year",
        targetField: $("#year")
     },
     {
        attachID: "firstname",
        targetField: $("#firstname")
     },
     {
        attachID: "lastname",
        targetField: $("#lastname")
     },
     {
        attachID: "email",
        targetField: $("#email")
     },
     {
        attachID: "phone",
        targetField: $("#phone")
     },
     {
        attachID: "genderGroup",
        targetField: $("input[name='sex']")
     },
     {
        attachID: "userRace",
        targetField: $("input[name='race']")
     },
     {
        attachID: "userEthnicity",
        targetField: $("input[name='ethnicity']")
     },
     //{
     //   attachID: "fillOrgs",
     //   targetField: $("input[name='organization']")
     //},
     {
        attachID: "rolesGroup",
        targetField: $("input[name='user_type']")
     }].forEach(function(o) {
        /*
        $("#profileForm #" + o.attachID).after('<div>' + '<i id="' + o.attachID + '_load" class="fa fa-spinner fa-spin load-icon fa-lg save-info" style="margin-left:4px; margin-top:4px" aria-hidden="true"></i><i id="' + o.attachID + '_success" class="fa fa-check success-icon save-info" style="color: green" aria-hidden="true">Updated</i><i id="' + o.attachID + '_error" class="fa fa-times error-icon save-info" style="color:red" aria-hidden="true">Unable to Update.System error.</i></div>');
        */
        getSaveLoaderDiv("profileForm", o.attachID);
        
        o.targetField.each(function() {
            $(this).attr("save-container-id", o.attachID);
            $(this).on("change", function() {
                var validator = $("#profileForm").data('bs.validator');
                if (!validator.hasErrors()) {
                    assembleContent.demo({{ user.id }},true, $(this));
                };
            });
            
        });
    });

    if (!(_isTouchDevice())) $('#indexNavBar span[data-toggle="tooltip"]').tooltip();

    $("html").click(function(event){
        $("#indexContainer").removeClass('open');
    });

    $("#indexNavBar span.index-list").click(function(event) {
        event.stopPropagation();
        $('#indexContainer').toggleClass('open');

    });


    var t = $("#profileForm").find("h4.profile-item-title");
    var indexContent = "<ul style='padding:0; margin:0; list-style-type:square'>";
        t.each(function() {
        indexContent += "<li style='margin-bottom:4px; cursor:pointer' onclick=' goTo(event, \"" + $(this).attr("id") + "\")'>" + $(this).text() + "</li>";
    });
    indexContent += "</ul>";
    $("#indexContainer").html(indexContent);


    // When there's a change, check validation and if good, assembleContent
    $('#profileForm').on('validated.bs.validator', function(e) {
        var validator = $(this).data('bs.validator');
        if (!validator.hasErrors()) {
           // assembleContent.demo({{ user.id }},true);
            $("#errorMsg").hide()
        } else {
            $("#errorMsg").fadeIn("slow")
        }
    });

    // Submit the form here
    $("#updateProfile").on("click", function(event){
        event.preventDefault()
        assembleContent.demo({{ user.id }},true);
        $("#confirmMsg").fadeIn();
    });

});

/** Remove patientQuestion functionality for now
var getQs = [ "biopsy", "pca_diag", "tx"];
$.each(getQs, function(i,val){
    $.ajax ({
        type: "GET",
        url: '/api/patient/{{ user.id }}/clinical/'+val
    }).done(function(data) {
        var $radios = $('input:radio[name='+val+']');
        if($radios.is(':checked') === false) {
            $radios.filter('[value='+data.value+']').prop('checked', true);
        }
    }).fail(function() {
        console.log("Problem retrieving data from server.")
    });
});

$("#patientQuestions input").on("change", function(){
    var toCall = $(this).attr("name");
    var theVal = $(this).val();
    $.ajax ({
        type: "POST",
        url: '/api/patient/{{ user.id }}/clinical/'+toCall,
        contentType: "application/json; charset=utf-8",
        dataType: 'json',
        data: JSON.stringify({value: theVal})
    }).done(function() {
        // Allow user to save with button, even though these answers have already been submitted
        $('#updateProfile').removeClass("disabled")
    }).fail(function() {
        alert("There was a problem saving your answers. Please try again.");
    });
});
**/

/** Get and Put roles **/
function setRoles() {
    tnthAjax.getRoles({{ user.id }}, true);
    $("#rolesGroup input:checkbox").on("click",function(){

        var roles = $("#rolesGroup input:checkbox:checked").map(function(){
            return { name: $(this).val() };
        }).get();
        var toSend = {"roles": roles};
        tnthAjax.putRoles({{user.id}},toSend);

    });
};
/* done in on change event for role now*/
//setRoles();

{% endblock %}
