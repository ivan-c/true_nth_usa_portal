{% extends "layout.html" %}
{% block main %}
{% from "flask_user/_macros.html" import back_btn, back_link %}
{% from "profile_macros.html" import profile, profileSaveBtn, profileImage %}
<div id="stickyMenu"></div>
<br/>
{% if providerPerspective == 'true' %}
{{ back_link('patients', _('Patients List')) }}
{% elif current_user.has_role('admin') and request.environ.HTTP_REFERER and request.environ.HTTP_REFERER.endswith("admin") %}
{{ back_link('admin', _('User List')) }}
{% else %}
{{ back_link(PORTAL, _('Home')) }}
{% endif %}
<a class="open" href="#"><span class="glyphicon index-list glyphicon glyphicon-list-alt" data-toggle="tooltip" data-placement="bottom" title="show/hide index list"></span></a>
<div class="left-panel"></div>
<div class="right-panel">
<div class="flex">
      <div id="profileHeader" class="profile-header">
        {% if user and user.username %}
          {% if providerPerspective == 'true' %}
              <h4 class="tnth-headline">{{ _("Patient Profile") }} <span class="profile-item-title">&nbsp;#{{ user.id}} - {{ user.username }}</span></h4>
          {% elif current_user.has_role('admin') %}
              <h4 class="tnth-headline">{{ _("Profile for") }} {{ user.username }}</h4>
          {% else %}
               <h4 class="tnth-headline">{{ _("My TrueNTH Profile") }}</h4>
          {% endif %}
        {% else %}
           <h4 class="tnth-headline">{{ _("TrueNTH Profile") }}</h4>
        {% endif %}
      </div>
      {{profileImage(user)}}
</div>
{% if (current_user.has_role(ROLE.STAFF) and user.has_role(ROLE.PATIENT)) %}
    <nav id="indexNavBar">
    <span class="glyphicon index-list glyphicon-list-alt" data-toggle="tooltip" data-placement="top" title="{{ _('index list') }}"></span>
    <span id="loginAsPatient" data-toggle="modal" data-target="#loginAsModal" class="link"><a data-toggle="tooltip" data-placement="top" title="For 'kiosk' style administration of an assessment">{{ _("Login as this Patient") }}</a></span>
    <div class="modal fade" id="loginAsModal" tabindex="-1" role="dialog" aria-labelledby="loginAsModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="loginAsModalLabel">{{ _("Login as this Patient") }}</h4>
              </div>
              <div class="modal-body" style="font-size:0.9em">
                <br/>
                <p class="text-left">{{ _('This is intended for "kiosk" style administration of an assessment, wherein the staff person "logs in as the patient", which logs the staff person out of their session, and automatically logs in this patient without their needing to enter login credentials. Proceed?') }}</p>
                <br/>
              </div>
              <div class="modal-footer">
                <a href="#" onclick="handleLoginAs();" class="btn btn-default" style="font-size:0.8em">{{ _("OK") }}</a>
                <button type="button" class="btn btn-default" data-dismiss="modal" style="font-size:0.8em">{{ _("Cancel") }}</button>
              </div>
            </div>
          </div>
    </div>
    </nav>
{% endif %}
<div id="indexContainer">{{ _("Index List") }}</div>
<br/>
<form id="profileForm" class="form tnth-form to-validate" role="form" data-toggle="validator">
  <div class="row">
      <div class="col-lg-12 col-md-12 col-sm-12">
          {{profile(user, current_user, consent_agreements)}}
          <br/>
          {% if providerPerspective == 'true' %}
             <br/><br/> {{ back_btn('patients','Patients List') }}
          {% else %}
              <br/><br/><a href="{{PORTAL}}/home" class="btn btn-xs btn-tnth-back"><small><b>&lt;</b> {{ _("Back to Home") }}</small></a>
          {% endif %}
      </div>
  </div>
</form>
</div>
{% endblock %}

{% block document_ready %}

{% if user.has_role('patient')  and (user.id != current_user.id) %}var patientId = {{user.id}};{% endif %}

function handleLoginAs() {
    //sessionStorage does not work allow addition of item in private mode
    try {
      sessionStorage.setItem("loginAsPatient", "true");
    } catch(e) {}
    location.replace('/login-as/{{user.id}}');
};

var __stickyMenu, __navBar, __stickyMenu_topPos, __homeFooter, __indexContainer, __indexIcon, __leftPanel;

$(document).ready(function(){

    $('#loginAsPatient a').tooltip();

    $("a.open").on("click", function(e) {
      // stop default browser behavior
      e.preventDefault();
      $("body").toggleClass("open-nav");
      $("#stickyMenu").toggleClass("sticky-show")
    });

    [{
        attachID: "month",
        targetField: $("#month"),
        customErrorField: $("#errorbirthday")
      },
     {
        attachID: "date",
        targetField: $("#date"),
        customErrorField: $("#errorbirthday")
     },
     {
        attachID: "year",
        targetField: $("#year"),
        customErrorField: $("#errorbirthday")
     },
     {
        attachID: "firstname",
        targetField: $("#firstname")
     },
     {
        attachID: "lastname",
        targetField: $("#lastname")
     },
     {
        attachID: "email"
     },
     {
        attachID: "phone",
        targetField: $("#phone")
     },
     {
        attachID: "locale",
        targetField: $("#locale")
     },
     {
        attachID: "profile-gender-list",
        targetField: $("input[name='sex']")
     },
     {
        attachID: "userRace",
        targetField: $("input[name='race']")
     },
     {
        attachID: "userEthnicity",
        targetField: $("input[name='ethnicity']")
     },
     {
        attachID: "profileStudyIDContainer",
        targetField: $("#profileStudyId")
     },
     {
        attachID: "rolesGroup",
        targetField: $("input[name='user_type']")
     }].forEach(function(o) {
        /** see main.js **/
        if (o.attachID) getSaveLoaderDiv("profileForm", o.attachID);
        if (o.targetField) {
          o.targetField.each(function() {
              $(this).attr("save-container-id", o.attachID);
              var triggerEvent = $(this).attr("type") == "text" ? "blur" : "change";
              $(this).on(triggerEvent, function() {
                if (this.validity.valid) {
                  var hasError = false;
                  if ($(this).attr("error-field")) {
                    var customErrorField = $("#" + $(this).attr("error-field"));
                    if (customErrorField.length > 0) {
                      if (customErrorField.text() != "") hasError = true;
                      else hasError = false;
                    } else hasError = false;
                  };

                  //console.log("hasError: " + hasError + " customText: " + customErrorField.text())
                  if (!hasError) assembleContent.demo({{ user.id }},true, $(this));
                };
              });
          });
        };
    });

    if (!(_isTouchDevice())) $('span[data-toggle="tooltip"]').tooltip();

    $("html").click(function(event){
        $("#indexContainer").removeClass('open');
    });

    $("#indexNavBar span.index-list").click(function(event) {
        event.stopPropagation();
        $('#indexContainer').toggleClass('open');
    });

    $(window).scroll(function() {
        if (!(__navBar.isOnScreen())) {
            __stickyMenu.css("top", "1em")
        } else {
          __stickyMenu.css("top",__stickyMenu_topPos);
        };
    });
    $(window).resize(function() {
        if (__stickyMenu.hasClass("sticky-show")) {
          if (__indexIcon.is(":visible")) $("a.open").trigger("click");
        }
        else {
          if (__leftPanel.is(":visible")) __indexContainer.removeClass("open");
        }
    });

    (function() {
      var t = $("#profileForm").find("h4.index-item");
      var indexContent = "<p class='title'><em>Click</em> each to go to section:</p><ul>";
          t.each(function() {
          if ($(this).is(":visible")) {
            indexContent += "<li><a href='#" + $(this).attr("id") + "'>"  + $(this).text() + "</a></li>";
          };
      });
      indexContent += "</ul>";
      $("#indexContainer").html(indexContent);
      $("#stickyMenu").html(indexContent);
      var listHeight = $("#stickyMenu ul").height();
      if (parseInt(listHeight) > 0) $("#stickyMenu").height(parseInt(listHeight) + 40);
    })();

    __stickyMenu = $("#stickyMenu"), __navBar = $("#profileHeader"), __stickyMenu_topPos = __stickyMenu.position().top, __homeFooter = $("#homeFooter"), __indexContainer = $("#indexContainer"), __indexIcon = $("#indexNavBar span.index-list"), __leftPanel = $(".left-panel");

    if (__leftPanel.is(":visible")) $("a.open").trigger("click");

    //in profile email is validated and updated after ajax call to check unique email
    $("#email").attr("update-on-validated", "true").attr("user-id", '{{user.id}}');

});

{% endblock %}
