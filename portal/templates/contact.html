{% extends "layout.html" %}
{% from "flask_user/_macros.html" import render_field, render_submit_field, back_btn, footer %}
{% block main %}
{{ back_btn(PORTAL, _('Home')) }}

<h3 class="tnth-headline">{{ _("Contact TrueNTH") }}</h3>
<p>{{ _("Use this form to get in touch with TrueNTH") }}</p>
<div class="row">
  <div class="col-md-7">

    <form id="profileForm" action="" method="post" class="tnth-form" data-toggle="validator" role="form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <div class="form-group">
        <label for="sendername">{{ _("Name") }}</label>
        <input type="text" class="form-control" name="sendername"
          id="sendername" data-error="{{ _('Please enter your name') }}"
          placeholder="{{ _('Your Name') }}" value="{{ sendername }}" required>
        <div class="help-block with-errors"></div>
      </div>
      <div class="form-group">
        <label for="email">{{ _("Email") }}</label>
        <input type="email" class="form-control" name="email"
          id="email" placeholder="{{ _('Your Email') }}" value="{{ email }}"
          data-error="{{ _('This is not a valid e-mail address, please double-check.') }}"
          required>
        <div class="help-block with-errors"></div>
      </div>
      <div class="form-group">
        <label for="subject">{{ _("Subject") }}</label>
        <input type="text" class="form-control" name="subject" id="subject" placeholder="{{ _('What is this about?') }}">
      </div>
      <div class="form-group">
        <label for="body">{{ _("Text") }}</label>
        <textarea class="form-control" rows="5" name="body" id="body" data-error="{{ _('Please add a message for TrueNTH') }}" placeholder="{{ _('What is on your mind?') }}" required></textarea>
        <div class="help-block with-errors"></div>
      </div>
      {% if not user and config.RECAPTCHA_SITE_KEY and config.RECAPTCHA_SECRET_KEY %}
      <div class="field-group">
        {{ recaptcha }}
      </div>
      {% endif %}
      <div class="post-contact-response response-message"></div>
      <div class="form-group">
        <button id="submitButton" class="btn btn-tnth-primary btn-lg">{{ _("Submit") }}</button>
      </div>
    </form>

  </div>

</div>

<script>
  $(document).ready(function(){
    $('#profileForm').validator({
      disable: false
    });
    $("#submitButton").on("click", function() {
        if ($("#sendername").val() != "" && $("#body").val() != "" && $("#email").val() != "") {
            $("#submitButton").hide();
            $('.post-contact-response').html('{{ _("Sending contact request...") }}');
            var formData = {};
            $("#profileForm").find("input, select, textarea").each(function() {
                  console.log($(this).attr("name") + " " + ($(this).val() || $(this).text()))
                  formData[$(this).attr("name")] = $(this).val() || $(this).text();
            });
            console.dir(formData)

           $.ajax({
                data: formData,
                type: 'POST',
                url: '/contact',
                dataType: 'json',
                success: function(response) {
                    var msgid = response['msgid']
                    document.location = '/contact/' + String(msgid)
                },
                error: function(response) {
                    var msg = $('<div></div>').html(response.responseText);
                    var error = $('p', msg).text()
                    $('.post-contact-response').html(error);
                    $("#submitButton").show();
                }
            });
            return false;
        } else {
            msg = '{{ _("Please confirm all fields are filled") }}'
            $('.post-contact-response').html(msg);
        };
    });
  })
</script>
{% block footer %}
{{footer(user=user)}}
{% endblock %}
{% endblock %}
