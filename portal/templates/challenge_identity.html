{% extends "layout.html" %}
{% block main %}
{% from "flask_user/_macros.html" import render_field %}

    <h4 class="tnth-headline">Identity Verification</h4>

    <hr/>

    <br/>

    <p class="profile-item-title">To ensure your personal details are not shared with others, please enter the following data for account confirmation.</p>

    <form  action="/challenge" method="post">

         {{ form.hidden_tag() }}
        <div id="identityVerificationContainer">
            <div class="row">
                <div class="col-md-6 col-xs-12">
                {{ render_field(form.first_name, tabindex=10) }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 col-xs-12">
                {{ render_field(form.last_name, tabindex=20) }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 col-xs-12">
                     {{ render_field(form.birthdate, tabindex=30) }}
                </div>
            </div>
        </div>
        &nbsp;&nbsp;<button type="submit" class="btn btn-tnth-primary">Confirm Identity</button>
    </form>

{% endblock %}

{% block document_ready %}
$(document).ready(function() {

    var now = new Date();
    //50 years ago
    var _defaultDate = new Date(now.getFullYear()-50,now.getMonth(),now.getDate());

    //html5 native date input field is only recognized in Chrome/Opera, and not others so use bootstrap datepicker object instead
    $("#identityVerificationContainer").find("#birthdate").prop("type", "text").attr("placeholder", "mm-dd-yyyy").attr("pattern", "(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-9])|(?:(?!02)(?:0[1-9]|1[0-2])-(?:30))|(?:(?:0[13578]|1[02])-31))-(?:19|20)[0-9]{2}");
    $("#birthdate")
    .datepicker({format: "mm-dd-yyyy", autoclose: true, defaultViewDate: {year:_defaultDate.getFullYear(), month:_defaultDate.getMonth(), day:_defaultDate.getDate()}, forceParse: false, startDate: "01-01-1920"})
    .on('changeDate', function (ev) {
        $(this).datepicker("hide");
    })
    .on('clearDate', function(ev) {
        $(this).datepicker("show");
    });

    $("#birthdate").datepicker("setDate", _defaultDate);
    $("#birthdate").datepicker("update");
    $("#birthdate").val("");

    $("#birthdate").on("keydown", function(ev) {
        if (ev.keyCode === 8 || ev.keyCode === 46 || ev.keyCode === 37 || ev.keyCode === 39) return; //backspace or delete or right or left arrow key
        var match0 = /^\d{3}$/;
        var match         = /^\d{2}[-]?\d{2}[-]?\d{1,4}$/;  //11-111
        var d = $(this).val();
        //if (match1.test(d)) d = d.slice(0, 2) + "-" + d.slice(2);
        if (match0.test(d)) {
            d = d.slice(0, 2) + "-" + d.slice(2);
        } else if (match.test(d)) {
            d = d.replace(/-/g, "");
            d = d.slice(0, 2) + "-" + d.slice(2,4) + "-" + d.slice(4);
        }
        $(this).val(d);
    });

});
{% endblock %}
