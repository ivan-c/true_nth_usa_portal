{% macro tou(terms) -%}
    <div id="topTerms">
        <h4 class="tnth-headline">{{ _("Terms of Use") }}</h4>
        <hr/>
        <br/>
        <p>{{ _("Thanks for signing up for TrueNTH. First, please review the terms of use to access the TrueNTH tools") }}:</p>
        <div class="well">
            <div id="termsText">
              {{ terms['asset']|safe if terms}}
            </div>
            <meta id="termsURL"
                  data-url="{{ terms['agreement_url']|safe if terms}}"/>
            <div id="termsExpand" class="tnth-hide">
              <a href=""><i class="fa fa-plus"></i> {{ _("View TrueNTH Terms") }}</a>
            </div>
            <div id="termsCheckbox">
              <label id="agreeLabel" data-agree="false" type="terms">
                <i class="fa fa-square-o fa-lg"></i> <span>{{ _("I consent and agree to the above terms.") }}</span>
              </label>
            </div>
            <br/>
        </div>
    </div>
    <div class="modal fade" id="termsReminderModal" tabindex="-1" role="dialog">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="termsReminderModalLabel">{{ _("To Continue") }}</h4>
              </div>
              <div class="modal-body">
                <br/>
                <p class="text-left text-danger">{{ _('You must agree to the terms and conditions by checking the provided checkbox.') }}</p>
                <br/>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">{{ _("OK") }}</button>
              </div>
            </div>
          </div>
    </div>
   <!--  {% if terms and terms['editorUrl'] %}<script>appendLREditContainer($("#topTerms"), "{{terms['editorUrl']}}", false);</script>{% endif %} -->
  {%- endmacro %}

  {% macro nameGroup() -%}
    <div class="row" id="nameGroup">
        <div class="col-md-5 col-xs-6">
          <div class="form-group float-input-label">
            <label>Name</label>
            <input class="form-control float-text init-queries-field" id="firstname" name="firstname" placeholder="{{ _('First Name') }}" type="text" required="required" data-error="{{ _('First name is required') }}"  />
            <div class="help-block with-errors"></div>
          </div>
        </div>
        <div class="col-md-5 col-xs-6">
          <div class="form-group float-input-label">
            <label>&nbsp;</label>
            <input class="form-control float-text init-queries-field" id="lastname" name="lastname" placeholder="{{ _('Last Name') }}" type="text" required="required" data-error="{{ _('Last name is required') }}" />
            <div class="help-block with-errors"></div>
          </div>
        </div>
    </div>
    <script>
      $(function () {
        $("#firstname, #lastname").each(function() {
            $(this).on("blur", function() {
              if ($(this).val() != "") assembleContent.demo($("#iq_userId").val());
            });
        });
      });
    </script>
  {%- endmacro %}

  {% macro rolesGroup() -%}
      <div class="form-group" id="rolesGroup">
          <div class="radio">
            <label>
              <input type="radio" class="init-queries-field" name="user_type" id="role_patient" value="patient"> {{ _("I'm a man who is concerned about prostate cancer for myself") }}
            </label>
          </div>
          <div class="radio">
            <label>
              <input type="radio" class="init-queries-field" name="user_type" id="role_caregiver" value="partner"> {{ _("I'm a caregiver, spouse or partner who wants to learn more about prostate cancer") }}
            </label>
          </div>
      </div>
      <script>$(function () { tnthAjax.getRoles($("#iq_userId").val());});</script>
  {%- endmacro %}

  {{tou()}}

  {% macro dobGroup() -%}
      <div id="bdGroup">
          <input type="hidden" name="birthDate" id="birthday" value="">
          <div class="form-group">
            <label>{{ _("Birth Date") }} <span class="bd-optional text-muted">{{_("(optional)")}}</span></label>
            <div class="row">
              <div class="col-md-4 col-xs-4">
                <input class="form-control bd-element init-queries-field" id="date" name="birthdayDate" placeholder="DD" type="text" maxlength="2" pattern="\d[\d]?" data-error="The birth day field is required and must be valid format" required />
              </div>
              <div class="col-md-4 col-xs-4">
                <select type="select" class="form-control bd-element init-queries-field" name="birthdayMonth" id="month" data-error="-- A birth month must be selected" required>
                  <option value="">{{ _("Month") }}...</option>
                  <option value="01">{{ _("January") }}</option>
                  <option value="02">{{ _("February") }}</option>
                  <option value="03">{{ _("March") }}</option>
                  <option value="04">{{ _("April") }}</option>
                  <option value="05">{{ _("May") }}</option>
                  <option value="06">{{ _("June") }}</option>
                  <option value="07">{{ _("July") }}</option>
                  <option value="08">{{ _("August") }}</option>
                  <option value="09">{{ _("September") }}</option>
                  <option value="10">{{ _("October") }}</option>
                  <option value="11">{{ _("November") }}</option>
                  <option value="12">{{ _("December") }}</option>
                </select>
              </div>
              <div class="col-md-4 col-xs-4">
                <input class="form-control bd-element init-queries-field" id="year" name="birthdayYear" placeholder="YYYY" type="text" maxlength="4" pattern = "(19|20)\d{2}" data-error="The birth year is required and must be in valid format" required />
              </div>
            </div>
            <div class="help-block with-errors" style="margin-top: 1em; padding-left: 1em"></div>
            <span id="errorbirthday" class="help-block tnth-hide custom-error" style="margin-top: 1em; padding-left: 1em; color: #a94442"></span>
        </div>
      </div>
  {%- endmacro %}
  {% macro patientQGroup(user) -%}
    <div id="patientQ">
        <div id="patBiopsy" data-topic="biopsy" class="pat-q">
          <br />
          <p class="pat-label">{{ _("Have you had a prostate cancer biopsy?") }}</p>
          <div class="form-group">
            <div class="radio biopsy-option">
              <label>
                <input type="radio" class="init-queries-field" name="biopsy" id="biopsy_yes" value="true"> {{ _("Yes") }}
              </label>
            </div>
            <div id="biopsyDateContainer" class="indent form-group">
            	<label for="biopsyDate">{{_("Biopsy Date")}}:</label>
            	<input id="biopsyDate" type="text" class="form-control" placeholder="MM/DD/YYYY" maxlength="10">
            	<div id="biopsyDateError" class="error-message post-biopsy-error"></div>
            </div>
            <div class="radio biopsy-option">
              <label>
                <input type="radio" class="init-queries-field" name="biopsy" id="biopsy_no" value="false"> {{ _("No") }}
              </label>
            </div>
             <div class="radio biopsy-option">
              <label>
                <input type="radio" class="init-queries-field" name="biopsy" id="biopsy_unknown" value="false" data-status="unknown"> {{ _("I don't know") }}
              </label>
            </div>
          </div>
        </div>
        <div id="patDiag" data-topic="pca_diag" class="tnth-hide pat-q">
          <br />
          <p class="pat-label">{{ _("Have you been diagnosed with prostate cancer?") }}</p>
          <div class="form-group">
            <div class="radio">
              <label>
                <input type="radio" class="init-queries-field" name="pca_diag" id="pca_diag_yes" value="true"> {{ _("Yes (my biopsy was positive)") }}
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" class="init-queries-field" name="pca_diag" id="pca_diag_no" value="false"> {{ _("No (my biopsy was negative)") }}
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" class="init-queries-field" name="pca_diag" id="pca_diag_unknown" value="false" data-status="unknown"> {{ _("I don't know") }}
              </label>
            </div>
          </div>
        </div>
        {% if not config.LOCALIZED_AFFILIATE_ORG %}
          <div id="patMeta" data-topic="pca_localized" class="tnth-hide pat-q">
             <br />
             <p class="pat-label">{{ _("Is the prostate cancer only within the prostate?") }}</p>
             <div class="form-group">
               <div class="radio">
                 <label>
                   <input type="radio" class="init-queries-field" name="pca_localized" id="pca_localized_yes" value="true"> {{ _("Yes") }}
                 </label>
               </div>
               <div class="radio">
                 <label>
                   <input type="radio" class="init-queries-field" name="pca_localized" id="pca_localized_no" value="false"> {{ _("No (the cancer is in other parts of my body, too)") }}
                 </label>
               </div>
                <div class="radio">
                 <label>
                   <input type="radio" class="init-queries-field" name="pca_localized" id="pca_localized_unknown" value="true" data-status="unknown"> {{ _("I don't know") }}
                 </label>
               </div>
             </div>
          </div>
        {% endif %}
        <div id="patTx" data-topic="tx" class="tnth-hide pat-q">
          <br />
          <p class="pat-label">{{ _("Have you begun prostate cancer treatment?") }}</p>
          <div class="form-group">
            <div class="radio">
                <label>
                  <input type="radio" class="init-queries-field" name="tx" id="tx_yes" value="true"> {{ _("Yes") }}
                </label>
            </div>
            <div class="radio">
                <label>
                <input type="radio" class="init-queries-field" name="tx" id="tx_no" value="false"> {{ _("No") }}
                </label>
            </div>
          </div>
        </div>
        <br/>
      </div>
      <script>
        function checkBiopsyDate(val) {
           if (!hasValue(val)) return false;
           var m = val.match(/(\/)/);
           if (!m || !m.length) return false;
           if (m && m.length < 2) return false;
           var initArray = val.split("/");
           if (initArray.length < 3) return false;
           //make sure at least all date items are there
           if (initArray[0].length == 0 || initArray[1].length == 0 || initArray[2].length < 4) return false;
           if (/((0)?[1-9]|1\d|2\d)\/((0)?[1-9]|1\d|2\d|3[01])\/(19|20)\d{2}/.test(val)) {
              var today = new Date();
              // Check to see if this is a real date
              var dArray = (val).split("/");
              var iy = parseInt(dArray[2]), im = parseInt(dArray[0]), iid=parseInt(dArray[1]);
              var date = new Date(iy,im-1,iid);
              var errorMsg = "";

              if (date.getFullYear() == iy && (date.getMonth() + 1) == im && date.getDate() == iid) {
                  if (iy < 1900) errorMsg = "Year must be after 1900";
                  // Only allow if date is before today
                  if (date.setHours(0,0,0,0) > today.setHours(0,0,0,0)) {
                      errorMsg = "The date must not be in the future.";
                  };
              } else errorMsg = "Invalid Date. Please enter a valid date.";

              if (errorMsg == "") {
                  $("#biopsyDateError").text("");
                  setTimeout('$("#biopsy_yes").trigger("click");', 500);
                  return true;
              } else {
                  $("#biopsyDateError").text(errorMsg);
                  return false;
              };
           } else {
              $("#biopsyDateError").text("Invalid date. Please enter the date in correct format (mm/dd/yyyy).");
              return false;
           };
        };
        $(function () {
          tnthAjax.getClinical($("#iq_userId").val());
          tnthAjax.getTreatment($("#iq_userId").val());
          var today = new Date();
          $("#biopsyDate").datepicker({"format": "mm/dd/yyyy", "forceParse": false, "endDate": today, "autoclose": true});
          $("#biopsyDate").on("keydown", function() {
            $("#biopsyDateError").text("");
            $(this).datepicker("hide");
          });
          $("input[name='biopsy']").each(function() {
          	$(this).on("click", function() {
          		if ($(this).val() == "true") {
          			$("#biopsyDateContainer").show();
          		} else {
          			$("#biopsyDate").val("");
                $("#biopsyDateError").text("");
          			$("#biopsyDateContainer").hide();
          		};
          	});
          });
          $("#biopsyDate").on("change", function() {
              return checkBiopsyDate($(this).val());
          });
          $("input[name='tx']").each(function() {
               $(this).on("click", function() {
                  if ($(this).val() == "true") {
                      tnthAjax.postTreatment($("#iq_userId").val(), true, "", $(this));
                  } else {
                      tnthAjax.postTreatment($("#iq_userId").val(), false, "", $(this));
                  };
               });
          });
        });</script>
  {%- endmacro %}
  {% macro clinic(consent_agreements) -%}
    <div id="clinics">
      <p class="subtitle">{{ _("What is your main clinic for prostate cancer care?") }}</p>
      <div class="form-group" id="userOrgs">
        <div style="margin-left: 10px">
          <div id="fillOrgs"></div>
          <div class="noOrg-container"><label><input id="noOrgs" class="clinic" type="checkbox" name="organization" value="0"><span>{{ _("I'm not receiving care at any of the above clinics") }}</span></label></div>
        </div>
      </div>
      {{consent(consent_agreements)}}
    </div>
    <script>
    function _orgsCallback() {
      {% if 'patient' in config.CONSENT_EDIT_PERMISSIBLE_ROLES %}
          var userOrgs = $("#userOrgs input[name='organization']").not('[parent_org]');
          if (userOrgs.length == 0) userOrgs = $("#userOrgs input[name='organization']");
          var checkedOrgs = {};
          userOrgs.each(function() {
              if ($(this).prop("checked")) {
                  checkedOrgs[$(this).val()] = true;
              };
              $(this).attr("type", "radio");
              if (checkedOrgs[$(this).val()]) $(this).prop("checked", true);
          });
      {% endif %}
    };
    $(function () {
        var CONSENT_WITH_TOP_LEVEL_ORG = {% if config.CONSENT_WITH_TOP_LEVEL_ORG %}true{% else %}false{% endif %};
        tnthAjax.getOrgs($("#iq_userId").val(), false,true, _orgsCallback);
      });
    </script>

  {%- endmacro %}
  {% macro consent(consent_agreements) -%}
    {% if consent_agreements %}
        <div id="consentContainer" style="display:none">
          {% for org in consent_agreements %}
            <div id="{{org}}_consentItem" class="well consent"><input type="hidden" id="{{org}}_agreement_url" value="{{consent_agreements[org].url}}" /></div>
          {% endfor %}
        </div>
      {% endif %}
  {%- endmacro %}


